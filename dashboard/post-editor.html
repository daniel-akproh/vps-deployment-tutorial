<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="editor.css">
    <link href="https://fonts.googleapis.com/css2?family=Italianno&display=swap" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <title>Post Editor - SimplySharon</title>
</head>

<body>
    <!-- Modern Navbar -->
    <nav class="modern-nav">
        <div class="nav-container">
            <a href="../index.html" class="nav-logo">
                <img src="../assets/images/logo.png" alt="">
                <span class="site-name">SimplySharon</span>
            </a>
            <ul class="nav-menu">
                <li><a href="../home.html">Home</a></li>
                <li><a href="../blog/blogcast.html">Blogcast</a></li>
                <li><a href="#">Make-Betters</a></li>
                <li><a href="#">Poise</a></li>
                <li><a href="#">About</a></li>
                <li><a href="#">Contact</a></li>
            </ul>
            <div class="nav-actions">
                <button class="login-btn logged-in">
                    <i class="ri-user-fill"></i>
                    <span class="login-text">Sharon D.</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Breadcrumb -->
    <div class="breadcrumb-container">
        <div class="breadcrumb">
            <a href="../index.html"><i class="ri-home-4-line"></i> Home</a>
            <span class="breadcrumb-separator">/</span>
            <a href="admin.html">Dashboard</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-current" id="editorTitle">New Post</span>
        </div>
    </div>

    <!-- Editor -->
    <main class="editor-content">
        <div class="editor-wrapper">
            <!-- Editor Header -->
            <div class="editor-header">
                <button class="btn-secondary" onclick="window.location.href='admin.html'">
                    ‚Üê Cancel
                </button>
                <div class="editor-actions">
                    <button class="btn-secondary" onclick="savePost('Draft')">üíæ Save Draft</button>
                    <button class="btn-primary" onclick="savePost('Published')">üöÄ Publish</button>
                </div>
            </div>

            <!-- Post Settings Sidebar -->
            <div class="editor-layout">
                <div class="editor-main">
                    <!-- Title -->
                    <input type="text" class="post-title" placeholder="Enter post title..." id="postTitle">

                    <!-- Subtitle -->
                    <input type="text" class="post-subtitle" placeholder="Add a subtitle (optional)..."
                        id="postSubtitle">

                    <!-- Toolbar -->
                    <div class="editor-toolbar">
                        <div class="toolbar-group">
                            <button class="toolbar-btn" title="Bold" data-command="bold">
                                <strong>B</strong>
                            </button>
                            <button class="toolbar-btn" title="Italic" data-command="italic">
                                <em>I</em>
                            </button>
                            <button class="toolbar-btn" title="Underline" data-command="underline">
                                <u>U</u>
                            </button>
                            <button class="toolbar-btn" title="Strikethrough" data-command="strikeThrough">
                                <s>S</s>
                            </button>
                        </div>

                        <div class="toolbar-divider"></div>

                        <div class="toolbar-group">
                            <select class="toolbar-select" id="headingSelect">
                                <option value="">Paragraph</option>
                                <option value="h1">Heading 1</option>
                                <option value="h2">Heading 2</option>
                                <option value="h3">Heading 3</option>
                                <option value="h4">Heading 4</option>
                            </select>
                        </div>

                        <div class="toolbar-divider"></div>

                        <div class="toolbar-group">
                            <button class="toolbar-btn" title="Align Left" data-command="justifyLeft">
                                ‚â°
                            </button>
                            <button class="toolbar-btn" title="Align Center" data-command="justifyCenter">
                                ‚â°
                            </button>
                            <button class="toolbar-btn" title="Align Right" data-command="justifyRight">
                                ‚â°
                            </button>
                        </div>

                        <div class="toolbar-divider"></div>

                        <div class="toolbar-group">
                            <button class="toolbar-btn" title="Bulleted List" data-command="insertUnorderedList">
                                ‚Ä¢
                            </button>
                            <button class="toolbar-btn" title="Numbered List" data-command="insertOrderedList">
                                1.
                            </button>
                            <button class="toolbar-btn" title="Quote" data-command="formatBlock"
                                data-value="blockquote">
                                "
                            </button>
                        </div>

                        <div class="toolbar-divider"></div>

                        <div class="toolbar-group">
                            <button class="toolbar-btn" title="Insert Link" id="linkBtn">
                                üîó
                            </button>
                            <button class="toolbar-btn" title="Insert Image" id="imageBtn">
                                üñºÔ∏è
                            </button>
                            <button class="toolbar-btn" title="Insert Code" data-command="formatBlock" data-value="pre">
                                &lt;/&gt;
                            </button>
                        </div>

                        <div class="toolbar-divider"></div>

                        <div class="toolbar-group">
                            <button class="toolbar-btn" title="Undo" data-command="undo">
                                ‚Ü∂
                            </button>
                            <button class="toolbar-btn" title="Redo" data-command="redo">
                                ‚Ü∑
                            </button>
                        </div>

                        <div class="toolbar-divider"></div>

                        <div class="toolbar-group">
                            <input type="color" class="color-picker" title="Text Color" id="textColor">
                            <button class="toolbar-btn" title="Clear Formatting" data-command="removeFormat">
                                üóô
                            </button>
                        </div>
                    </div>

                    <!-- Content Editor -->
                    <div class="content-editor" contenteditable="true" id="contentEditor">
                        <p>Start writing your post here...</p>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="editor-sidebar">
                    <!-- Post Settings -->
                    <div class="sidebar-section">
                        <h3>‚öôÔ∏è Post Settings</h3>
                        <div class="setting-item">
                            <label>Status</label>
                            <select class="setting-select">
                                <option>Draft</option>
                                <option>Published</option>
                                <option>Scheduled</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <label>Category</label>
                            <select class="setting-select">
                                <option>Beauty</option>
                                <option>Wellness</option>
                                <option>Wisdom</option>
                                <option>Aging</option>
                                <option>Lifestyle</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <label>Tags</label>
                            <input type="text" class="setting-input" placeholder="Add tags...">
                        </div>
                        <div class="setting-item">
                            <label>Publish Date</label>
                            <input type="datetime-local" class="setting-input">
                        </div>
                    </div>

                    <!-- Featured Image -->
                    <div class="sidebar-section">
                        <h3>üñºÔ∏è Featured Image</h3>
                        <div class="image-upload">
                            <div class="upload-placeholder">
                                <span>üì∑</span>
                                <p>Click to upload</p>
                            </div>
                            <input type="file" id="featuredImage" accept="image/*" style="display: none;">
                        </div>
                    </div>

                    <!-- SEO -->
                    <div class="sidebar-section">
                        <h3>üîç SEO Settings</h3>
                        <div class="setting-item">
                            <label>Meta Title</label>
                            <input type="text" class="setting-input" placeholder="SEO title...">
                            <small>0/60 characters</small>
                        </div>
                        <div class="setting-item">
                            <label>Meta Description</label>
                            <textarea class="setting-textarea" placeholder="SEO description..." rows="3"></textarea>
                            <small>0/160 characters</small>
                        </div>
                        <div class="setting-item">
                            <label>URL Slug</label>
                            <input type="text" class="setting-input" placeholder="post-url-slug">
                        </div>
                    </div>

                    <!-- Visibility -->
                    <div class="sidebar-section">
                        <h3>üëÅÔ∏è Visibility</h3>
                        <div class="setting-item">
                            <label class="checkbox-label">
                                <input type="checkbox" checked>
                                <span>Show on homepage</span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <label class="checkbox-label">
                                <input type="checkbox" checked>
                                <span>Allow comments</span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <label class="checkbox-label">
                                <input type="checkbox">
                                <span>Featured post</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // API Configuration - automatically detects environment
        const API_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000/api' 
            : 'YOUR_BACKEND_URL/api'; // Replace with your deployed backend URL

        const API = {
            createPost: async (postData) => {
                try {
                    console.log('Creating post:', postData);
                    const response = await fetch(`${API_URL}/posts`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(postData)
                    });
                    const data = await response.json();
                    console.log('Response:', data);
                    return data;
                } catch (error) {
                    console.error('API Error:', error);
                    throw error;
                }
            },

            updatePost: async (id, postData) => {
                try {
                    console.log('Updating post:', id, postData);
                    const response = await fetch(`${API_URL}/posts/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(postData)
                    });
                    const data = await response.json();
                    console.log('Response:', data);
                    return data;
                } catch (error) {
                    console.error('API Error:', error);
                    throw error;
                }
            },

            getPostById: async (id) => {
                try {
                    const response = await fetch(`${API_URL}/posts/${id}`);
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('API Error:', error);
                    throw error;
                }
            }
        };
    </script>

    <script>
        // Check if editing existing post
        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get('id');
        let currentPost = null;

        // Load existing post if editing
        if (postId) {
            loadPost(postId);
        }

        async function loadPost(id) {
            try {
                const response = await API.getPostById(id);
                if (response.success) {
                    currentPost = response.data;
                    populateEditor(currentPost);
                    document.getElementById('editorTitle').textContent = 'Edit Post';
                }
            } catch (error) {
                console.error('Error loading post:', error);
                alert('Error loading post. Please try again.');
            }
        }

        function populateEditor(post) {
            document.getElementById('postTitle').value = post.title || '';
            document.getElementById('postSubtitle').value = post.subtitle || '';
            document.getElementById('contentEditor').innerHTML = post.content || '<p>Start writing your post here...</p>';

            // Status
            const statusSelect = document.querySelector('.setting-select');
            statusSelect.value = post.status || 'Draft';

            // Category
            const categorySelect = document.querySelectorAll('.setting-select')[1];
            categorySelect.value = post.category || 'Lifestyle';

            // Tags
            const tagsInput = document.querySelector('.setting-item:nth-child(3) .setting-input');
            if (post.tags && post.tags.length > 0) {
                tagsInput.value = post.tags.join(', ');
            }

            // Publish date
            const publishDateInput = document.querySelector('input[type="datetime-local"]');
            if (post.publishDate) {
                const date = new Date(post.publishDate);
                publishDateInput.value = date.toISOString().slice(0, 16);
            }

            // SEO
            const metaTitle = document.querySelector('.sidebar-section:nth-child(3) .setting-item:nth-child(2) .setting-input');
            const metaDesc = document.querySelector('.setting-textarea');
            const urlSlug = document.querySelector('.sidebar-section:nth-child(3) .setting-item:nth-child(4) .setting-input');

            if (post.seo) {
                metaTitle.value = post.seo.metaTitle || '';
                metaDesc.value = post.seo.metaDescription || '';
            }
            urlSlug.value = post.slug || '';

            // Visibility
            const checkboxes = document.querySelectorAll('.checkbox-label input[type="checkbox"]');
            if (post.visibility) {
                checkboxes[0].checked = post.visibility.showOnHomepage;
                checkboxes[1].checked = post.visibility.allowComments;
                checkboxes[2].checked = post.visibility.featured;
            }

            // Featured image
            if (post.featuredImage) {
                const placeholder = document.querySelector('.upload-placeholder');
                placeholder.style.backgroundImage = `url(${post.featuredImage})`;
                placeholder.style.backgroundSize = 'cover';
                placeholder.innerHTML = '';
            }
        }

        // Toolbar functionality
        const editor = document.getElementById('contentEditor');

        document.querySelectorAll('.toolbar-btn[data-command]').forEach(btn => {
            btn.addEventListener('click', () => {
                const command = btn.getAttribute('data-command');
                const value = btn.getAttribute('data-value') || null;
                document.execCommand(command, false, value);
                editor.focus();
            });
        });

        // Heading select
        document.getElementById('headingSelect').addEventListener('change', function () {
            const value = this.value;
            if (value) {
                document.execCommand('formatBlock', false, value);
            } else {
                document.execCommand('formatBlock', false, 'p');
            }
            editor.focus();
        });

        // Text color
        document.getElementById('textColor').addEventListener('change', function () {
            document.execCommand('foreColor', false, this.value);
            editor.focus();
        });

        // Link insertion
        document.getElementById('linkBtn').addEventListener('click', () => {
            const url = prompt('Enter URL:');
            if (url) {
                document.execCommand('createLink', false, url);
                editor.focus();
            }
        });

        // Image insertion
        document.getElementById('imageBtn').addEventListener('click', () => {
            const url = prompt('Enter image URL:');
            if (url) {
                document.execCommand('insertImage', false, url);
                editor.focus();
            }
        });

        // Featured image upload
        document.querySelector('.upload-placeholder').addEventListener('click', () => {
            document.getElementById('featuredImage').click();
        });

        document.getElementById('featuredImage').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    const placeholder = document.querySelector('.upload-placeholder');
                    placeholder.style.backgroundImage = `url(${event.target.result})`;
                    placeholder.style.backgroundSize = 'cover';
                    placeholder.innerHTML = '';
                };
                reader.readAsDataURL(file);
            }
        });

        // Character counters
        const metaTitle = document.querySelector('.sidebar-section:nth-child(3) .setting-item:nth-child(2) .setting-input');
        const metaDesc = document.querySelector('.setting-textarea');

        metaTitle?.addEventListener('input', function () {
            const count = this.value.length;
            this.nextElementSibling.textContent = `${count}/60 characters`;
        });

        metaDesc?.addEventListener('input', function () {
            const count = this.value.length;
            this.nextElementSibling.textContent = `${count}/160 characters`;
        });

        // Save/Update Post Function
        async function savePost(status) {
            try {
                // Get all form data
                const title = document.getElementById('postTitle')?.value.trim() || '';
                const subtitle = document.getElementById('postSubtitle')?.value.trim() || '';
                const content = document.getElementById('contentEditor')?.innerHTML || '';

                // Validation
                if (!title) {
                    alert('Please enter a post title');
                    return;
                }

                if (content === '<p>Start writing your post here...</p>' || !content.trim()) {
                    alert('Please write some content for your post');
                    return;
                }

                // Get other fields with safe fallbacks
                const statusSelects = document.querySelectorAll('.setting-select');
                const statusSelect = statusSelects[0];
                const categorySelect = statusSelects[1];

                const settingInputs = document.querySelectorAll('.setting-input');
                const tagsInput = settingInputs[0]; // Tags input is the first setting-input
                const publishDateInput = document.querySelector('input[type="datetime-local"]');

                // Get SEO fields - these are in the third sidebar section
                const seoSection = document.querySelectorAll('.sidebar-section')[2]; // 0-indexed, so 2 is the 3rd section (SEO)
                const seoInputs = seoSection?.querySelectorAll('.setting-input') || [];
                const metaTitleInput = seoInputs[0];
                const urlSlugInput = seoInputs[1];
                const metaDescInput = seoSection?.querySelector('.setting-textarea');

                // Get visibility checkboxes
                const checkboxes = document.querySelectorAll('.checkbox-label input[type="checkbox"]');

                // Get featured image (base64 if uploaded)
                const placeholder = document.querySelector('.upload-placeholder');
                let featuredImage = '';
                if (placeholder?.style.backgroundImage) {
                    featuredImage = placeholder.style.backgroundImage.slice(5, -2);
                }

                // Prepare tags array
                const tagsArray = tagsInput?.value ? tagsInput.value.split(',').map(tag => tag.trim()) : [];

                // Build post data
                const postData = {
                    title: title,
                    subtitle: subtitle,
                    content: content,
                    category: categorySelect?.value || 'Lifestyle',
                    tags: tagsArray,
                    status: status,
                    featuredImage: featuredImage,
                    publishDate: publishDateInput?.value ? new Date(publishDateInput.value) : new Date(),
                    slug: urlSlugInput?.value || null,
                    metaTitle: metaTitleInput?.value || '',
                    metaDescription: metaDescInput?.value || '',
                    showOnHomepage: checkboxes[0]?.checked ?? true,
                    allowComments: checkboxes[1]?.checked ?? true,
                    featured: checkboxes[2]?.checked ?? false
                };

                // Show loading state
                const saveBtn = event.target;
                const originalText = saveBtn.innerHTML;
                saveBtn.disabled = true;
                saveBtn.innerHTML = '‚è≥ Saving...';

                let response;

                if (postId && currentPost) {
                    // Update existing post
                    response = await API.updatePost(postId, postData);
                } else {
                    // Create new post
                    response = await API.createPost(postData);
                }

                // Restore button
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;

                if (response.success) {
                    alert(postId ? 'Post updated successfully!' : 'Post created successfully!');

                    // Redirect to admin dashboard
                    window.location.href = 'admin.html';
                } else {
                    alert('Error saving post: ' + (response.message || 'Unknown error'));
                }

            } catch (error) {
                console.error('Error saving post:', error);
                console.error('Error details:', error.message);
                alert('Error saving post: ' + error.message + '\n\nMake sure to access the page via http://localhost:3000/dashboard/post-editor.html (not file://)');
            }
        }
    </script>

</body>

</html>